<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Shoe Customizer with ScanSoles</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8fafc;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .scan-section, .customization-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .customization-section {
      display: none;
    }
    button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:disabled {
      background-color: #cbd5e1;
      cursor: not-allowed;
    }
    .scan-overlay {
      position: relative;
      height: 300px;
      background-color: #e2e8f0;
      border-radius: 4px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .progress-container {
      width: 80%;
      background-color: #e2e8f0;
      border-radius: 4px;
      margin: 20px auto;
    }
    .progress-bar {
      height: 20px;
      background-color: #4f46e5;
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s;
    }
    .error {
      color: #dc2626;
      background-color: #fee2e2;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    canvas {
      width: 100%;
      height: 500px;
      display: block;
      margin-top: 20px;
    }
    .customization-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    select, input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Custom Shoe Fitting</h1>
    
    <div id="scan-section" class="scan-section">
      <h2>Foot Scanning</h2>
      <div id="scan-error" class="error" style="display: none;"></div>
      
      <div class="scan-overlay">
        <div id="scanning-animation" style="display: none;">
          <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
          </div>
          <p>Position your foot in the frame</p>
        </div>
      </div>
      
      <button id="start-scan">Start Scan</button>
    </div>
    
    <div id="customization-section" class="customization-section">
      <h2>Customize Your Shoe</h2>
      
      <div class="customization-options">
        <select id="shoe-style">
          <option value="sneaker">Sneaker</option>
          <option value="runner">Runner</option>
          <option value="dress">Dress</option>
          <option value="boot">Boot</option>
        </select>
        
        <input type="color" id="shoe-color" value="#ff0000">
        
        <select id="shoe-material">
          <option value="leather">Leather</option>
          <option value="mesh">Mesh</option>
          <option value="knit">Knit</option>
        </select>
        
        <button id="update-shoe">Update Shoe</button>
      </div>
      
      <canvas id="shoe-canvas"></canvas>
      <div id="shoe-loading" style="display: none;">Loading shoe model...</div>
      <div id="customization-error" class="error" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Global variables
    let footScanData = null;
    let scene, camera, renderer, controls, shoeMesh;
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize 3D viewer
      init3DViewer();
      
      // Event listeners
      document.getElementById('start-scan').addEventListener('click', startRealScan);
      document.getElementById('update-shoe').addEventListener('click', updateShoeModel);
    });
    
    // Initialize 3D viewer
    function init3DViewer() {
      const canvas = document.getElementById('shoe-canvas');
      
      // Scene setup
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf8fafc);
      
      // Camera setup
      camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
      camera.position.z = 5;
      
      // Renderer setup
      renderer = new THREE.WebGLRenderer({ 
        canvas: canvas,
        antialias: true,
        alpha: true
      });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      
      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 5, 5);
      scene.add(directionalLight);
      
      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      
      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
      
      // Handle window resize
      window.addEventListener('resize', function() {
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      });
    }
    
    // Start real scan with ScanSoles
    async function startRealScan() {
      const startBtn = document.getElementById('start-scan');
      const errorElement = document.getElementById('scan-error');
      
      startBtn.textContent = 'Scanning...';
      startBtn.disabled = true;
      errorElement.style.display = 'none';
      
      document.getElementById('scanning-animation').style.display = 'block';
      simulateScanProgress();
      
      try {
        // Load ScanSoles SDK dynamically
        await loadScript('https://sdk.scansoles.com/v1/latest.js');
        
        // Initialize ScanSoles SDK
        await ScanSoles.init({ 
          apiKey: process.env.SCANSOLES_API_KEY,
          scanMode: 'singleFoot',
          scanQuality: 'high',
          overlayElement: document.querySelector('.scan-overlay')
        });
        
        // Start the scan
        const scanResult = await ScanSoles.startScan({
          onProgress: (progress) => {
            document.getElementById('progress-bar').style.width = `${progress}%`;
          }
        });
        
        // Process scan results
        footScanData = {
          footLength: scanResult.measurements.footLength,
          footWidth: scanResult.measurements.footWidth,
          archHeight: scanResult.measurements.archHeight,
          meshUrl: scanResult.meshUrl
        };
        
        // Show customization section
        document.getElementById('scan-section').classList.add('hidden');
        document.getElementById('customization-section').style.display = 'block';
        
        // Load initial shoe model
        loadShoeModel();
      } catch (err) {
        console.error("Scan failed:", err);
        errorElement.textContent = "Scan failed: " + err.message;
        errorElement.style.display = 'block';
      } finally {
        startBtn.textContent = 'Start Scan';
        startBtn.disabled = false;
      }
    }
    
    // Simulate scan progress (fallback)
    function simulateScanProgress() {
      const progressBar = document.getElementById('progress-bar');
      let progress = 0;
      const interval = setInterval(() => {
        progress += 5;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
        }
      }, 200);
    }
    
    // Load shoe model
    async function loadShoeModel() {
      const style = document.getElementById('shoe-style').value;
      const color = document.getElementById('shoe-color').value;
      const material = document.getElementById('shoe-material').value;
      
      document.getElementById('shoe-loading').style.display = 'block';
      document.getElementById('customization-error').style.display = 'none';
      
      try {
        // Call Netlify function to generate shoe
        const response = await fetch('/Netlify/Functions/generate-shoe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            footScanData,
            style,
            color,
            material
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to generate shoe model');
        }
        
        const { modelUrl } = await response.json();
        
        const loader = new THREE.GLTFLoader();
        loader.load(modelUrl, (gltf) => {
          if (shoeMesh) scene.remove(shoeMesh);
          shoeMesh = gltf.scene;
          
          // Scale the model based on foot scan data if available
          if (footScanData) {
            const scaleFactor = footScanData.footLength / 26; // Adjust based on model size
            shoeMesh.scale.set(scaleFactor, scaleFactor, scaleFactor);
          }
          
          // Apply material customization
          shoeMesh.traverse((child) => {
            if (child.isMesh) {
              child.material.color.setHex(color.replace('#', '0x'));
              if (material === 'mesh') {
                child.material.transparent = true;
                child.material.opacity = 0.8;
              } else if (material === 'leather') {
                child.material.roughness = 0.4;
                child.material.metalness = 0.1;
              } else if (material === 'knit') {
                child.material.roughness = 0.8;
                child.material.metalness = 0;
              }
            }
          });
          
          scene.add(shoeMesh);
          document.getElementById('shoe-loading').style.display = 'none';
          
          // Center the model in view
          if (shoeMesh) {
            const box = new THREE.Box3().setFromObject(shoeMesh);
            const center = box.getCenter(new THREE.Vector3());
            shoeMesh.position.sub(center);
            controls.reset();
          }
        }, undefined, (err) => {
          throw err;
        });
      } catch (err) {
        console.error("Error loading shoe model:", err);
        document.getElementById('shoe-loading').style.display = 'none';
        document.getElementById('customization-error').textContent = "Failed to load shoe model. Please try again.";
        document.getElementById('customization-error').style.display = 'block';
      }
    }
    
    // Update shoe model based on customization
    function updateShoeModel() {
      if (footScanData) {
        loadShoeModel();
      }
    }
    
    // Helper function to load scripts dynamically
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
  </script>
</body>
</html>
