<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedOS Clinical Collaboration Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.4.0"></script>
    <style>
        :root {
            --primary: #1976d2;
            --secondary: #28a745;
            --danger: #dc3545;
            --dark: #343a40;
            --light: #f8f9fa;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }
        .main-content {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #1565c0;
        }
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        .btn-secondary:hover {
            background: #218838;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .module-card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .module-card.active {
            background: var(--primary);
        }
        .video-container {
            position: relative;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .video-container video {
            width: 100%;
            display: block;
        }
        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .suggestion-card {
            border-left: 3px solid var(--primary);
            padding: 10px;
            margin: 10px 0;
            background: #f5fbff;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            border-bottom-color: var(--primary);
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .patient-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        .diagnosis-history {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .history-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .diagnosis-result {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
        }
        .diagnosis-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2e7d32;
        }
        .diagnosis-list {
            margin-left: 20px;
        }
        .diagnosis-item {
            margin-bottom: 8px;
        }
        .diagnosis-confidence {
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        .processing-mode {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .peace-mode {
            background-color: #4caf50;
            color: white;
        }
        .wait-mode {
            background-color: #ff9800;
            color: white;
        }
        .mixed-mode {
            background-color: #9c27b0;
            color: white;
        }
        .clinical-summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .workup-recommendations {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        #annotationCanvas {
            border: 1px solid #ddd;
            background: white;
        }
        .model-status {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .model-loading {
            background: #fff3cd;
            color: #856404;
        }
        .model-ready {
            background: #d4edda;
            color: #155724;
        }
        .model-error {
            background: #f8d7da;
            color: #721c24;
        }
        /* Facial Recognition Styles */
        .face-verification-container {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        #faceVideo {
            width: 100%;
            background: #000;
            border-radius: 8px;
        }
        #faceCanvas {
            display: none;
        }
        .verification-steps {
            margin-top: 15px;
        }
        .verification-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .verification-step i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .step-complete {
            color: #28a745;
        }
        .step-pending {
            color: #6c757d;
        }
        .step-active {
            color: #007bff;
            font-weight: bold;
        }
        .verification-result {
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        .verification-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .verification-failure {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .clinician-profile {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .clinician-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #ddd;
            margin-right: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clinician-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .clinician-details {
            flex: 1;
        }
        .clinician-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .clinician-license {
            font-size: 0.9em;
            color: #666;
        }
        .license-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .status-verified {
            background: #28a745;
            color: white;
        }
        .status-pending {
            background: #ffc107;
            color: #000;
        }
        .status-unverified {
            background: #dc3545;
            color: white;
        }
        .cadre-selector {
            margin-top: 15px;
        }
        .cadre-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>MedOS</h2>
            <div class="module-list">
                <div class="module-card active" data-tab="consultation">
                    <h4><i class="fas fa-users"></i> Consultation Rooms</h4>
                </div>
                <div class="module-card" data-tab="diagnostic">
                    <h4><i class="fas fa-robot"></i> AI Diagnostic</h4>
                </div>
                <div class="module-card" data-tab="screenshare">
                    <h4><i class="fas fa-desktop"></i> Screen Sharing</h4>
                </div>
                <div class="module-card" data-tab="ehr">
                    <h4><i class="fas fa-hospital"></i> EHR Simulator</h4>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4>Active Sessions</h4>
                <ul id="active-sessions">
                    <li>General Medicine (2 users)</li>
                    <li>Cardiology (1 user)</li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="tab-container">
                <div class="tab active" data-tab="consultation">Consultation</div>
                <div class="tab" data-tab="diagnostic">AI Diagnostic</div>
                <div class="tab" data-tab="screenshare">Screen Share</div>
                <div class="tab" data-tab="ehr">EHR Simulator</div>
            </div>

            <!-- Consultation Rooms -->
            <div class="tab-content active" id="consultation">
                <h2>Consultation Rooms</h2>
                <div class="card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                        <div class="room-card">
                            <h3>General Medicine</h3>
                            <button class="btn btn-primary join-room" data-room="general">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                        <div class="room-card">
                            <h3>Cardiology</h3>
                            <button class="btn btn-primary join-room" data-room="cardiology">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                        <div class="room-card">
                            <h3>Neurology</h3>
                            <button class="btn btn-primary join-room" data-room="neurology">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                        <div class="room-card">
                            <h3>Pediatrics</h3>
                            <button class="btn btn-primary join-room" data-room="pediatrics">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Diagnostic -->
            <div class="tab-content" id="diagnostic">
                <h2>AI Clinical Diagnostic</h2>
                <div class="card">
                    <div id="modelStatus" class="model-status model-loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading AI model...
                    </div>
                    
                    <form id="diagnosticForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="modelType">AI Model:</label>
                                <select id="modelType" class="btn" style="width: 100%;">
                                    <option value="clinicalbert">ClinicalBERT</option>
                                    <option value="bioclinicalbert">BioClinicalBERT</option>
                                    <option value="pubmedbert">PubMedBERT</option>
                                </select>
                            </div>
                            <div>
                                <label for="specialty">Specialty:</label>
                                <select id="specialty" class="btn" style="width: 100%;">
                                    <option value="general">General Medicine</option>
                                    <option value="cardiology">Cardiology</option>
                                    <option value="neurology">Neurology</option>
                                    <option value="pulmonology">Pulmonology</option>
                                    <option value="gastroenterology">Gastroenterology</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="patientName">Patient Name:</label>
                            <input type="text" id="patientName" class="btn" style="width: 100%; padding: 10px;" placeholder="Enter patient name">
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="patientAge">Patient Age:</label>
                            <input type="number" id="patientAge" class="btn" style="width: 100%; padding: 10px;" placeholder="Enter patient age">
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="patientGender">Patient Gender:</label>
                            <select id="patientGender" class="btn" style="width: 100%;">
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="subjective">Subjective:</label>
                            <textarea id="subjective" placeholder="Patient's symptoms, history, duration, severity..."></textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="objective">Objective:</label>
                            <textarea id="objective" placeholder="Vital signs, physical exam findings, lab results, imaging..."></textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="assessment">Assessment:</label>
                            <textarea id="assessment" placeholder="Clinical impressions, working diagnosis..."></textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="plan">Plan:</label>
                            <textarea id="plan" placeholder="Treatment recommendations, follow-up plans..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-secondary" style="margin-top: 20px;" id="analyzeBtn" disabled>
                            <i class="fas fa-play"></i> Generate Diagnosis
                        </button>
                    </form>

                    <div id="diagnosticResults" style="margin-top: 30px; display: none;">
                        <h3>AI Diagnosis Results <span id="processingModeBadge" class="processing-mode"></span></h3>
                        <div class="suggestion-card">
                            <div id="aiResultContent"></div>
                            <button id="saveToEHRBtn" class="btn btn-primary" style="margin-top: 10px;">
                                <i class="fas fa-clipboard"></i> Save to EHR
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen Sharing -->
            <div class="tab-content" id="screenshare">
                <h2>Clinical Screen Sharing</h2>
                <div class="card">
                    <div class="video-container">
                        <video id="remoteScreen" autoplay playsinline></video>
                        <div class="video-controls">
                            <button id="startShareBtn" class="btn btn-primary">
                                <i class="fas fa-share-square"></i> Share Screen
                            </button>
                            <button id="stopShareBtn" class="btn btn-danger" disabled>
                                <i class="fas fa-stop"></i> Stop Sharing
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3>Collaboration Tools</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn" id="drawBtn">
                                <i class="fas fa-pencil-alt"></i> Draw
                            </button>
                            <button class="btn" id="highlightBtn">
                                <i class="fas fa-highlighter"></i> Highlight
                            </button>
                            <button class="btn" id="zoomBtn">
                                <i class="fas fa-search-plus"></i> Zoom
                            </button>
                            <button class="btn" id="clearCanvasBtn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>

                        <canvas id="annotationCanvas" width="800" height="400" style="border: 1px solid #ddd; margin-bottom: 20px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- EHR Simulator with Facial Recognition -->
            <div class="tab-content" id="ehr">
                <h2>Secure EHR System</h2>
                <div class="card">
                    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px;">
                        <!-- Left Column - Clinician Verification -->
                        <div>
                            <div class="clinician-profile">
                                <div class="clinician-avatar">
                                    <img id="clinicianAvatar" src="https://ui-avatars.com/api/?name=MD&background=1976d2&color=fff" alt="Clinician">
                                </div>
                                <div class="clinician-details">
                                    <div class="clinician-name" id="clinicianName">Medical Doctor</div>
                                    <div class="clinician-license">
                                        License: <span id="clinicianLicense">KMPDC-12345</span>
                                        <span class="license-status status-pending" id="licenseStatus">Pending</span>
                                    </div>
                                </div>
                            </div>

                            <div class="cadre-selector">
                                <label for="cadreType">Medical Cadre:</label>
                                <select id="cadreType" class="btn" style="width: 100%;">
                                    <option value="MD">Medical Doctor (MD)</option>
                                    <option value="CO">Clinical Officer (CO)</option>
                                    <option value="RN">Registered Nurse (RN)</option>
                                </select>
                            </div>

                            <!-- Facial Recognition Verification -->
                            <div class="face-verification-container">
                                <h4>Identity Verification</h4>
                                <div class="verification-steps">
                                    <div class="verification-step" id="step1">
                                        <i class="fas fa-circle step-pending"></i>
                                        <span>Start facial recognition</span>
                                    </div>
                                    <div class="verification-step" id="step2">
                                        <i class="fas fa-circle step-pending"></i>
                                        <span>Position your face</span>
                                    </div>
                                    <div class="verification-step" id="step3">
                                        <i class="fas fa-circle step-pending"></i>
                                        <span>Complete verification</span>
                                    </div>
                                </div>

                                <div style="margin-top: 15px;">
                                    <video id="faceVideo" autoplay playsinline></video>
                                    <canvas id="faceCanvas"></canvas>
                                </div>

                                <div style="margin-top: 15px; text-align: center;">
                                    <button id="startVerificationBtn" class="btn btn-primary">
                                        <i class="fas fa-id-card"></i> Start Verification
                                    </button>
                                    <button id="retryVerificationBtn" class="btn btn-secondary" style="display: none;">
                                        <i class="fas fa-redo"></i> Retry
                                    </button>
                                </div>

                                <div id="verificationResult" class="verification-result">
                                    <i class="fas fa-check-circle" style="font-size: 2em;"></i>
                                    <h3 id="resultMessage">Verification Successful</h3>
                                    <p id="resultDetails">You can now access patient records</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Patient Records -->
                        <div>
                            <h3 id="currentPatient">No Patient Selected</h3>
                            <div id="patientAccessStatus" style="margin-bottom: 15px; padding: 10px; border-radius: 4px; display: none;">
                                <i class="fas fa-lock"></i> Please complete identity verification to access patient records
                            </div>

                            <div id="patientRecords" style="display: none;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <h4>Patient List</h4>
                                    <button id="refreshPatientsBtn" class="btn">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>

                                <ul id="patientList" style="list-style: none; padding: 0;">
                                    <li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" data-id="1001">
                                        John Smith (58M)
                                        <span class="patient-tag">Verified</span>
                                    </li>
                                    <li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" data-id="1002">
                                        Sarah Lee (42F)
                                        <span class="patient-tag">Verified</span>
                                    </li>
                                    <li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" data-id="1003">
                                        Miguel Garcia (67M)
                                        <span class="patient-tag">Pending</span>
                                    </li>
                                </ul>

                                <div id="patientDetails" style="margin-top: 20px; display: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h4>Patient Details</h4>
                                        <span class="license-status status-verified">Verified</span>
                                    </div>

                                    <div style="margin-top: 15px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <label>Name:</label>
                                                <div class="card" style="padding: 10px;">John Smith</div>
                                            </div>
                                            <div>
                                                <label>Age/Gender:</label>
                                                <div class="card" style="padding: 10px;">58 / Male</div>
                                            </div>
                                        </div>

                                        <div style="margin-top: 15px;">
                                            <label>Diagnosis:</label>
                                            <div class="card" style="padding: 10px;">Hypertension, Type 2 Diabetes</div>
                                        </div>

                                        <div style="margin-top: 15px;">
                                            <label>Medications:</label>
                                            <div class="card" style="padding: 10px;">
                                                <ul>
                                                    <li>Lisinopril 10mg daily</li>
                                                    <li>Metformin 500mg BID</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div style="margin-top: 15px;">
                                            <label>Progress Notes:</label>
                                            <textarea class="card" style="width: 100%; min-height: 100px; padding: 10px;">58yo male with HTN and DM2. BP today 145/88. Glucose 132.</textarea>
                                        </div>

                                        <button class="btn btn-primary" style="margin-top: 15px;">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MedOS Core Application with Local AI Processing and Facial Recognition
        class MedOS {
            constructor() {
                this.activeRoom = null;
                this.peer = null;
                this.stream = null;
                this.completedDiagnostics = [];
                this.patients = {
                    '1001': {
                        name: 'John Smith',
                        age: 58,
                        gender: 'M',
                        diagnosis: 'Hypertension, Type 2 Diabetes',
                        medications: ['Lisinopril 10mg daily', 'Metformin 500mg BID'],
                        notes: '58yo male with HTN and DM2. BP today 145/88. Glucose 132.',
                        aiHistory: []
                    },
                    '1002': {
                        name: 'Sarah Lee',
                        age: 42,
                        gender: 'F',
                        diagnosis: 'Migraine, Anxiety',
                        medications: ['Sumatriptan 50mg PRN', 'Sertraline 50mg daily'],
                        notes: '42yo female with chronic migraines. Reports increased frequency.',
                        aiHistory: []
                    },
                    '1003': {
                        name: 'Miguel Garcia',
                        age: 67,
                        gender: 'M',
                        diagnosis: 'COPD, CAD',
                        medications: ['Advair 250/50 BID', 'Aspirin 81mg daily'],
                        notes: '67yo male with COPD exacerbation. O2 sat 92% on RA.',
                        aiHistory: []
                    }
                };
                this.currentPatientId = null;
                this.currentDiagnosticResult = null;
                this.isDrawing = false;
                this.isHighlighting = false;
                this.isZooming = false;
                this.canvasCtx = null;
                this.canvasDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.pipeline = null;
                this.modelInitialized = false;
                this.faceDetectionActive = false;
                this.faceVideo = null;
                this.faceCanvas = null;
                this.faceCanvasCtx = null;
                this.verificationSteps = [];
                this.currentStep = 0;
                this.verificationComplete = false;
                this.clinicianVerified = false;
                this.cadreType = 'MD'; // Default to Medical Doctor
            }

            async init() {
                this.setupTabs();
                this.setupConsultation();
                await this.initializeModels();
                this.setupDiagnostic();
                this.setupScreenShare();
                this.setupEHRSimulator();
                this.setupAnnotationCanvas();
                this.setupFaceVerification();
                this.setupCadreSelector();
            }

            setupCadreSelector() {
                const cadreSelector = document.getElementById('cadreType');
                cadreSelector.addEventListener('change', (e) => {
                    this.cadreType = e.target.value;
                    this.updateClinicianProfile();
                });
            }

            updateClinicianProfile() {
                const clinicianName = document.getElementById('clinicianName');
                const clinicianLicense = document.getElementById('clinicianLicense');
                const clinicianAvatar = document.getElementById('clinicianAvatar');
                
                switch(this.cadreType) {
                    case 'MD':
                        clinicianName.textContent = 'Medical Doctor';
                        clinicianLicense.textContent = 'KMPDC-' + Math.floor(10000 + Math.random() * 90000);
                        clinicianAvatar.src = "https://ui-avatars.com/api/?name=MD&background=1976d2&color=fff";
                        break;
                    case 'CO':
                        clinicianName.textContent = 'Clinical Officer';
                        clinicianLicense.textContent = 'KMPDC-CO-' + Math.floor(1000 + Math.random() * 9000);
                        clinicianAvatar.src = "https://ui-avatars.com/api/?name=CO&background=28a745&color=fff";
                        break;
                    case 'RN':
                        clinicianName.textContent = 'Registered Nurse';
                        clinicianLicense.textContent = 'NCK-' + Math.floor(10000 + Math.random() * 90000);
                        clinicianAvatar.src = "https://ui-avatars.com/api/?name=RN&background=dc3545&color=fff";
                        break;
                }
                
                // Reset verification when cadre changes
                this.clinicianVerified = false;
                document.getElementById('licenseStatus').className = 'license-status status-pending';
                document.getElementById('licenseStatus').textContent = 'Pending';
                document.getElementById('patientAccessStatus').style.display = 'block';
                document.getElementById('patientRecords').style.display = 'none';
                this.resetFaceVerification();
            }

            async initializeModels() {
                const statusElement = document.getElementById('modelStatus');
                try {
                    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading AI model (this may take a few minutes)...';
                    
                    // Initialize the pipeline with a medical text classification model
                    this.pipeline = await transformers.pipeline(
                        'text-classification', 
                        'Xenova/biobert-v1.1-finetuned-mimiciii-discharge-summaries'
                    );
                    
                    this.modelInitialized = true;
                    statusElement.className = 'model-status model-ready';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> AI model ready for analysis';
                    document.getElementById('analyzeBtn').disabled = false;
                    
                    console.log("AI model initialized successfully");
                } catch (error) {
                    console.error("Error initializing AI model:", error);
                    statusElement.className = 'model-status model-error';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to load AI model. Using fallback analysis.';
                    
                    // Initialize a simple fallback pipeline
                    this.pipeline = {
                        async pipeline(text) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            return [
                                { label: "Common Condition", score: 0.85 },
                                { label: "Possible Infection", score: 0.75 },
                                { label: "Chronic Disease", score: 0.65 }
                            ];
                        }
                    };
                    this.modelInitialized = true;
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }

            setupTabs() {
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                const moduleCards = document.querySelectorAll('.module-card');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabContents.forEach(content => content.classList.remove('active'));
                        tabs.forEach(t => t.classList.remove('active'));
                        
                        const tabId = tab.dataset.tab;
                        document.getElementById(tabId).classList.add('active');
                        tab.classList.add('active');
                    });
                });

                moduleCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const tabId = card.dataset.tab;
                        tabContents.forEach(content => content.classList.remove('active'));
                        tabs.forEach(t => t.classList.remove('active'));
                        
                        document.getElementById(tabId).classList.add('active');
                        document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                    });
                });
            }

            setupConsultation() {
                const joinButtons = document.querySelectorAll('.join-room');
                
                joinButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const room = button.dataset.room;
                        this.activeRoom = room;
                        alert(`Joined ${room} consultation room`);
                    });
                });
            }

            setupAnnotationCanvas() {
                const canvas = document.getElementById('annotationCanvas');
                this.canvasCtx = canvas.getContext('2d');
                this.canvasCtx.strokeStyle = '#1976d2';
                this.canvasCtx.lineWidth = 2;
                this.canvasCtx.lineJoin = 'round';
                this.canvasCtx.lineCap = 'round';

                // Drawing functionality
                canvas.addEventListener('mousedown', (e) => {
                    if (this.isDrawing || this.isHighlighting) {
                        this.canvasDrawing = true;
                        const rect = canvas.getBoundingClientRect();
                        this.lastX = e.clientX - rect.left;
                        this.lastY = e.clientY - rect.top;
                    }
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!this.canvasDrawing) return;
                    
                    const rect = canvas.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    this.canvasCtx.beginPath();
                    this.canvasCtx.moveTo(this.lastX, this.lastY);
                    this.canvasCtx.lineTo(currentX, currentY);
                    this.canvasCtx.stroke();
                    
                    this.lastX = currentX;
                    this.lastY = currentY;
                });

                canvas.addEventListener('mouseup', () => {
                    this.canvasDrawing = false;
                });

                canvas.addEventListener('mouseleave', () => {
                    this.canvasDrawing = false;
                });

                // Set up tool buttons
                document.getElementById('drawBtn').addEventListener('click', () => {
                    this.isDrawing = true;
                    this.isHighlighting = false;
                    this.isZooming = false;
                    this.canvasCtx.strokeStyle = '#1976d2';
                    this.canvasCtx.lineWidth = 2;
                });

                document.getElementById('highlightBtn').addEventListener('click', () => {
                    this.isDrawing = false;
                    this.isHighlighting = true;
                    this.isZooming = false;
                    this.canvasCtx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                    this.canvasCtx.lineWidth = 10;
                });

                document.getElementById('zoomBtn').addEventListener('click', () => {
                    this.isDrawing = false;
                    this.isHighlighting = false;
                    this.isZooming = true;
                    alert('Zoom tool selected. Click and drag to zoom area.');
                });

                document.getElementById('clearCanvasBtn').addEventListener('click', () => {
                    this.canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                });
            }

            setupFaceVerification() {
                this.faceVideo = document.getElementById('faceVideo');
                this.faceCanvas = document.getElementById('faceCanvas');
                this.faceCanvasCtx = this.faceCanvas.getContext('2d');
                this.verificationSteps = [
                    document.getElementById('step1'),
                    document.getElementById('step2'),
                    document.getElementById('step3')
                ];

                // Set up verification buttons
                document.getElementById('startVerificationBtn').addEventListener('click', () => this.startFaceVerification());
                document.getElementById('retryVerificationBtn').addEventListener('click', () => this.resetFaceVerification());

                // Initialize verification steps
                this.resetVerificationSteps();
            }

            resetVerificationSteps() {
                this.verificationSteps.forEach((step, index) => {
                    const icon = step.querySelector('i');
                    icon.className = 'fas fa-circle step-pending';
                });
                this.currentStep = 0;
                this.verificationComplete = false;
            }

            async startFaceVerification() {
                if (this.faceDetectionActive) return;

                try {
                    // Reset previous verification
                    this.resetVerificationSteps();
                    document.getElementById('verificationResult').style.display = 'none';
                    document.getElementById('startVerificationBtn').disabled = true;

                    // Start with step 1
                    this.updateVerificationStep(0, true);

                    // Access camera
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480, facingMode: 'user' },
                        audio: false
                    });
                    
                    this.faceVideo.srcObject = stream;
                    this.faceDetectionActive = true;

                    // Move to step 2 after a delay
                    setTimeout(() => {
                        this.updateVerificationStep(1, true);
                        this.detectFace();
                    }, 2000);
                } catch (error) {
                    console.error("Error accessing camera:", error);
                    alert("Could not access camera. Please ensure you have granted camera permissions.");
                    this.resetFaceVerification();
                }
            }

            detectFace() {
                if (!this.faceDetectionActive) return;

                // In a real implementation, this would use a face detection library like face-api.js
                // For this demo, we'll simulate face detection with random success

                // Set canvas dimensions
                this.faceCanvas.width = this.faceVideo.videoWidth;
                this.faceCanvas.height = this.faceVideo.videoHeight;

                // Draw video frame to canvas
                this.faceCanvasCtx.drawImage(
                    this.faceVideo, 
                    0, 0, 
                    this.faceCanvas.width, 
                    this.faceCanvas.height
                );

                // Simulate face detection (80% chance of success)
                const detectionSuccess = Math.random() < 0.8;

                if (detectionSuccess) {
                    // Simulate face matching (70% chance of success)
                    const verificationSuccess = Math.random() < 0.7;

                    setTimeout(() => {
                        this.updateVerificationStep(2, true);
                        this.completeVerification(verificationSuccess);
                    }, 2000);
                } else {
                    setTimeout(() => {
                        this.updateVerificationStep(1, false);
                        this.retryVerification("Could not detect face. Please try again.");
                    }, 2000);
                }
            }

            updateVerificationStep(stepIndex, success) {
                if (stepIndex >= this.verificationSteps.length) return;

                const step = this.verificationSteps[stepIndex];
                const icon = step.querySelector('i');

                // Update all steps up to current
                for (let i = 0; i <= stepIndex; i++) {
                    const stepIcon = this.verificationSteps[i].querySelector('i');
                    if (i < stepIndex) {
                        stepIcon.className = 'fas fa-check-circle step-complete';
                    } else if (i === stepIndex) {
                        if (success) {
                            stepIcon.className = 'fas fa-check-circle step-complete';
                        } else {
                            stepIcon.className = 'fas fa-times-circle step-pending';
                        }
                    }
                }

                this.currentStep = stepIndex;
            }

            completeVerification(success) {
                this.faceDetectionActive = false;
                this.verificationComplete = true;
                this.clinicianVerified = success;

                const resultDiv = document.getElementById('verificationResult');
                const resultMessage = document.getElementById('resultMessage');
                const resultDetails = document.getElementById('resultDetails');

                if (success) {
                    resultDiv.className = 'verification-result verification-success';
                    resultMessage.textContent = 'Verification Successful';
                    resultDetails.textContent = 'Identity confirmed. You can now access patient records.';
                    
                    // Update clinician status
                    document.getElementById('licenseStatus').className = 'license-status status-verified';
                    document.getElementById('licenseStatus').textContent = 'Verified';
                    
                    // Enable patient records
                    document.getElementById('patientAccessStatus').style.display = 'none';
                    document.getElementById('patientRecords').style.display = 'block';
                } else {
                    resultDiv.className = 'verification-result verification-failure';
                    resultMessage.textContent = 'Verification Failed';
                    resultDetails.textContent = 'Face did not match records. Please try again.';
                    
                    // Show retry button
                    document.getElementById('retryVerificationBtn').style.display = 'inline-block';
                }

                resultDiv.style.display = 'block';
                document.getElementById('startVerificationBtn').style.display = 'none';

                // Stop video stream
                if (this.faceVideo.srcObject) {
                    this.faceVideo.srcObject.getTracks().forEach(track => track.stop());
                    this.faceVideo.srcObject = null;
                }
            }

            retryVerification(message) {
                this.faceDetectionActive = false;
                
                const resultDiv = document.getElementById('verificationResult');
                resultDiv.className = 'verification-result verification-failure';
                document.getElementById('resultMessage').textContent = 'Verification Issue';
                document.getElementById('resultDetails').textContent = message || 'Please try again.';
                resultDiv.style.display = 'block';
                
                document.getElementById('retryVerificationBtn').style.display = 'inline-block';
                document.getElementById('startVerificationBtn').style.display = 'none';

                // Stop video stream
                if (this.faceVideo.srcObject) {
                    this.faceVideo.srcObject.getTracks().forEach(track => track.stop());
                    this.faceVideo.srcObject = null;
                }
            }

            resetFaceVerification() {
                this.faceDetectionActive = false;
                this.verificationComplete = false;
                
                // Reset UI elements
                document.getElementById('verificationResult').style.display = 'none';
                document.getElementById('retryVerificationBtn').style.display = 'none';
                document.getElementById('startVerificationBtn').style.display = 'inline-block';
                document.getElementById('startVerificationBtn').disabled = false;
                
                this.resetVerificationSteps();

                // Clear canvas
                this.faceCanvasCtx.clearRect(0, 0, this.faceCanvas.width, this.faceCanvas.height);
            }

            determineProcessingMode(soapData) {
                const text = `${soapData.subjective} ${soapData.objective} ${soapData.assessment}`.toLowerCase();
                
                const acuteKeywords = ['acute', 'sudden', 'severe', 'emergency', 'pain'];
                const chronicKeywords = ['chronic', 'persistent', 'recurrent', 'months', 'years'];
                const progressiveKeywords = ['worsening', 'progressing', 'increasing', 'developing'];
                const completeKeywords = ['complete', 'full', 'results', 'findings', 'diagnosis'];
                
                let modeScore = {
                    peace: 0,
                    wait: 0
                };
                
                completeKeywords.forEach(kw => {
                    if (text.includes(kw)) modeScore.peace += 1;
                });
                
                progressiveKeywords.forEach(kw => {
                    if (text.includes(kw)) modeScore.wait += 1;
                });
                
                if (text.includes('vitals') && text.includes('labs')) modeScore.peace += 2;
                if (text.includes('trend') || text.includes('follow up')) modeScore.wait += 2;
                
                if (modeScore.peace > modeScore.wait) {
                    return { mode: 'Peace Mode', description: 'Complete clinical picture available' };
                } else if (modeScore.wait > modeScore.peace) {
                    return { mode: 'Wait Mode', description: 'Progressive condition monitoring' };
                } else {
                    return { mode: 'Mixed Mode', description: 'Combination of complete and progressive elements' };
                }
            }

            async analyzeClinicalText(text) {
                if (!this.modelInitialized) {
                    throw new Error("AI models are still loading. Please try again shortly.");
                }
                
                try {
                    const result = await this.pipeline(text, {
                        topk: 3 // Get top 3 probable diagnoses
                    });
                    
                    return result;
                } catch (error) {
                    console.error("Error analyzing clinical text:", error);
                    throw new Error("Failed to analyze clinical text");
                }
            }

            formatDiagnosisResults(analysis, soapData) {
                const mode = this.determineProcessingMode(soapData);
                
                let html = `
                    <div class="diagnosis-result">
                        <div class="diagnosis-header">Differential Diagnosis (Ranked by Likelihood):</div>
                        <div class="diagnosis-list">
                `;
                
                analysis.forEach((item, index) => {
                    html += `
                        <div class="diagnosis-item">
                            <strong>${index + 1}. ${item.label}</strong> (${Math.round(item.score * 100)}% confidence)
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="diagnosis-confidence">
                            Processing Mode: ${mode.mode} | 
                            Overall Analysis Confidence: ${Math.round(analysis[0]?.score * 100)}%
                        </div>
                    </div>
                    
                    <div class="clinical-summary">
                        <strong>Clinical Summary:</strong>
                        <p><u>Subjective:</u> ${soapData.subjective || 'Not provided'}</p>
                        <p><u>Objective:</u> ${soapData.objective || 'Not provided'}</p>
                        <p><u>Assessment:</u> ${soapData.assessment || 'Not provided'}</p>
                    </div>
                    
                    <div class="workup-recommendations">
                        <strong>Recommended Workup:</strong>
                        <ul>
                            <li>Complete blood count with differential</li>
                            <li>Comprehensive metabolic panel</li>
                            <li>Inflammatory markers (CRP, ESR)</li>
                            ${analysis[0].label.includes('Cardiac') ? '<li>Cardiac enzymes, EKG</li>' : ''}
                            ${analysis[0].label.includes('Pulmonary') ? '<li>Chest X-ray, oxygen saturation</li>' : ''}
                            ${analysis[0].label.includes('Neurologic') ? '<li>CT head, neurological exam</li>' : ''}
                            <li>Additional testing as clinically indicated</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        <i>Disclaimer: This AI-generated diagnosis is for clinical decision support only. Final diagnosis and treatment decisions should be made by a qualified healthcare provider.</i>
                    </div>
                `;
                
                return {
                    response: html,
                    confidence: analysis[0]?.score || 0.85,
                    processingMode: mode.mode
                };
            }

            setupDiagnostic() {
                const form = document.getElementById('diagnosticForm');
                const saveToEHRBtn = document.getElementById('saveToEHRBtn');
                
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const modelType = document.getElementById('modelType').value;
                    const specialty = document.getElementById('specialty').value;
                    const patientName = document.getElementById('patientName').value;
                    const patientAge = document.getElementById('patientAge').value;
                    const patientGender = document.getElementById('patientGender').value;
                    const subjective = document.getElementById('subjective').value;
                    const objective = document.getElementById('objective').value;
                    const assessment = document.getElementById('assessment').value;
                    const plan = document.getElementById('plan').value;
                    
                    if (!patientName || !patientAge) {
                        alert("Please enter patient name and age");
                        return;
                    }
                    
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<span class="loading"></span> Processing...';
                    submitBtn.disabled = true;
                    
                    try {
                        const prompt = {
                            patientName,
                            patientAge,
                            patientGender,
                            specialty,
                            subjective,
                            objective,
                            assessment,
                            plan
                        };
                        
                        // Combine all clinical text for analysis
                        const clinicalText = `
                            Patient: ${patientName}, ${patientAge}${patientGender}
                            Specialty: ${specialty}
                            Subjective: ${subjective}
                            Objective: ${objective}
                            Assessment: ${assessment}
                            Plan: ${plan}
                        `;
                        
                        // Get analysis from local model
                        const analysis = await this.analyzeClinicalText(clinicalText);
                        
                        // Format results
                        const result = this.formatDiagnosisResults(analysis, prompt);
                        
                        this.currentDiagnosticResult = {
                            ...prompt,
                            modelType,
                            result: result.response,
                            confidence: result.confidence,
                            processingMode: result.processingMode,
                            timestamp: new Date().toISOString()
                        };
                        
                        document.getElementById('aiResultContent').innerHTML = result.response;
                        document.getElementById('diagnosticResults').style.display = 'block';
                        
                        const modeBadge = document.getElementById('processingModeBadge');
                        modeBadge.textContent = result.processingMode;
                        modeBadge.className = `processing-mode ${
                            result.processingMode.includes('Peace') ? 'peace-mode' : 
                            result.processingMode.includes('Wait') ? 'wait-mode' : 'mixed-mode'
                        }`;
                        
                        saveToEHRBtn.disabled = false;
                        
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    } finally {
                        submitBtn.innerHTML = '<i class="fas fa-play"></i> Generate Diagnosis';
                        submitBtn.disabled = false;
                    }
                });
                
                saveToEHRBtn.addEventListener('click', () => {
                    if (!this.currentDiagnosticResult) {
                        alert("No diagnostic result to save");
                        return;
                    }
                    
                    this.completedDiagnostics.push(this.currentDiagnosticResult);
                    this.updatePatientList();
                    alert("Diagnostic results saved to EHR");
                });
            }

            updatePatientList() {
                const patientList = document.getElementById('patientList');
                patientList.innerHTML = '';
                
                Object.keys(this.patients).forEach(id => {
                    const patient = this.patients[id];
                    const li = document.createElement('li');
                    li.style.padding = '8px';
                    li.style.borderBottom = '1px solid #eee';
                    li.style.cursor = 'pointer';
                    li.dataset.id = id;
                    li.textContent = `${patient.name} (${patient.age}${patient.gender})`;
                    
                    if (patient.aiHistory.length > 0) {
                        const tag = document.createElement('span');
                        tag.className = 'patient-tag';
                        tag.textContent = 'AI';
                        li.appendChild(tag);
                    }
                    
                    li.addEventListener('click', () => this.showPatientDetails(id));
                    patientList.appendChild(li);
                });
                
                this.completedDiagnostics.forEach((diagnostic, index) => {
                    const patientKey = `${diagnostic.patientName}-${diagnostic.patientAge}`;
                    const existingItem = Array.from(patientList.children).find(item => 
                        item.textContent.includes(`${diagnostic.patientName} (${diagnostic.patientAge}${diagnostic.patientGender}`));
                    
                    if (!existingItem) {
                        const li = document.createElement('li');
                        li.style.padding = '8px';
                        li.style.borderBottom = '1px solid #eee';
                        li.style.cursor = 'pointer';
                        li.dataset.id = `diag-${index}`;
                        li.textContent = `${diagnostic.patientName} (${diagnostic.patientAge}${diagnostic.patientGender})`;
                        
                        const tag = document.createElement('span');
                        tag.className = 'patient-tag';
                        tag.textContent = 'AI';
                        li.appendChild(tag);
                        
                        li.addEventListener('click', () => this.showDiagnosticPatient(diagnostic));
                        patientList.appendChild(li);
                    }
                });
            }

            showPatientDetails(patientId) {
                if (!this.clinicianVerified) {
                    document.getElementById('patientAccessStatus').style.display = 'block';
                    document.getElementById('patientRecords').style.display = 'none';
                    return;
                }

                this.currentPatientId = patientId;
                const patient = this.patients[patientId];
                const currentPatient = document.getElementById('currentPatient');
                const patientDetails = document.getElementById('patientDetails');
                
                currentPatient.textContent = `${patient.name} (${patient.age}${patient.gender})`;
                
                // In a real implementation, this would show detailed patient records
                patientDetails.style.display = 'block';
            }

            showDiagnosticPatient(diagnostic) {
                this.currentPatientId = null;
                const currentPatient = document.getElementById('currentPatient');
                const patientDetails = document.getElementById('patientDetails');
                
                currentPatient.textContent = `${diagnostic.patientName} (${diagnostic.patientAge}${diagnostic.patientGender})`;
                
                // In a real implementation, this would show diagnostic details
                patientDetails.style.display = 'block';
            }

            setupScreenShare() {
                const startBtn = document.getElementById('startShareBtn');
                const stopBtn = document.getElementById('stopShareBtn');
                const remoteVideo = document.getElementById('remoteScreen');
                
                startBtn.addEventListener('click', async () => {
                    try {
                        this.stream = await navigator.mediaDevices.getDisplayMedia({
                            video: true,
                            audio: false
                        });
                        
                        remoteVideo.srcObject = this.stream;
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        
                        this.stream.getTracks()[0].onended = () => {
                            stopBtn.click();
                        };
                    } catch (err) {
                        console.error('Screen sharing failed:', err);
                    }
                });
                
                stopBtn.addEventListener('click', () => {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        remoteVideo.srcObject = null;
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                });
            }

            setupEHRSimulator() {
                const saveNoteBtn = document.getElementById('saveNoteBtn');
                
                this.updatePatientList();
                
                // Handle patient selection
                document.getElementById('patientList').addEventListener('click', (e) => {
                    let target = e.target;
                    while (target && target.nodeName !== 'LI') {
                        target = target.parentElement;
                    }
                    if (target && target.dataset.id) {
                        if (target.dataset.id.startsWith('diag-')) {
                            const index = parseInt(target.dataset.id.split('-')[1]);
                            this.showDiagnosticPatient(this.completedDiagnostics[index]);
                        } else {
                            this.showPatientDetails(target.dataset.id);
                        }
                    }
                });
                
                // Show access restriction if not verified
                if (!this.clinicianVerified) {
                    document.getElementById('patientAccessStatus').style.display = 'block';
                    document.getElementById('patientRecords').style.display = 'none';
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            const medos = new MedOS();
            await medos.init();
        });
    </script>
</body>
</html>
