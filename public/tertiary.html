<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedOS Clinical Collaboration Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.4.0"></script>
    <style>
        :root {
            --primary: #1976d2;
            --secondary: #28a745;
            --danger: #dc3545;
            --dark: #343a40;
            --light: #f8f9fa;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }
        .main-content {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #1565c0;
        }
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        .btn-secondary:hover {
            background: #218838;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .module-card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .module-card.active {
            background: var(--primary);
        }
        .video-container {
            position: relative;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .video-container video {
            width: 100%;
            display: block;
        }
        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .suggestion-card {
            border-left: 3px solid var(--primary);
            padding: 10px;
            margin: 10px 0;
            background: #f5fbff;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            border-bottom-color: var(--primary);
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .patient-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        .diagnosis-history {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .history-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .diagnosis-result {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
        }
        .diagnosis-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2e7d32;
        }
        .diagnosis-list {
            margin-left: 20px;
        }
        .diagnosis-item {
            margin-bottom: 8px;
        }
        .diagnosis-confidence {
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        .processing-mode {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .peace-mode {
            background-color: #4caf50;
            color: white;
        }
        .wait-mode {
            background-color: #ff9800;
            color: white;
        }
        .mixed-mode {
            background-color: #9c27b0;
            color: white;
        }
        .clinical-summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .workup-recommendations {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        #annotationCanvas {
            border: 1px solid #ddd;
            background: white;
        }
        .model-status {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .model-loading {
            background: #fff3cd;
            color: #856404;
        }
        .model-ready {
            background: #d4edda;
            color: #155724;
        }
        .model-error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>MedOS</h2>
            <div class="module-list">
                <div class="module-card active" data-tab="consultation">
                    <h4><i class="fas fa-users"></i> Consultation Rooms</h4>
                </div>
                <div class="module-card" data-tab="diagnostic">
                    <h4><i class="fas fa-robot"></i> AI Diagnostic</h4>
                </div>
                <div class="module-card" data-tab="screenshare">
                    <h4><i class="fas fa-desktop"></i> Screen Sharing</h4>
                </div>
                <div class="module-card" data-tab="ehr">
                    <h4><i class="fas fa-hospital"></i> EHR Simulator</h4>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4>Active Sessions</h4>
                <ul id="active-sessions">
                    <li>General Medicine (2 users)</li>
                    <li>Cardiology (1 user)</li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="tab-container">
                <div class="tab active" data-tab="consultation">Consultation</div>
                <div class="tab" data-tab="diagnostic">AI Diagnostic</div>
                <div class="tab" data-tab="screenshare">Screen Share</div>
                <div class="tab" data-tab="ehr">EHR Simulator</div>
            </div>

            <!-- Consultation Rooms -->
            <div class="tab-content active" id="consultation">
                <h2>Consultation Rooms</h2>
                <div class="card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                        <div class="room-card">
                            <h3>General Medicine</h3>
                            <button class="btn btn-primary join-room" data-room="general">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                        <div class="room-card">
                            <h3>Cardiology</h3>
                            <button class="btn btn-primary join-room" data-room="cardiology">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                        <div class="room-card">
                            <h3>Neurology</h3>
                            <button class="btn btn-primary join-room" data-room="neurology">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                        <div class="room-card">
                            <h3>Pediatrics</h3>
                            <button class="btn btn-primary join-room" data-room="pediatrics">
                                <i class="fas fa-door-open"></i> Join
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Diagnostic -->
            <div class="tab-content" id="diagnostic">
                <h2>AI Clinical Diagnostic</h2>
                <div class="card">
                    <div id="modelStatus" class="model-status model-loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading AI model...
                    </div>
                    
                    <form id="diagnosticForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="modelType">AI Model:</label>
                                <select id="modelType" class="btn" style="width: 100%;">
                                    <option value="clinicalbert">ClinicalBERT</option>
                                    <option value="bioclinicalbert">BioClinicalBERT</option>
                                    <option value="pubmedbert">PubMedBERT</option>
                                </select>
                            </div>
                            <div>
                                <label for="specialty">Specialty:</label>
                                <select id="specialty" class="btn" style="width: 100%;">
                                    <option value="general">General Medicine</option>
                                    <option value="cardiology">Cardiology</option>
                                    <option value="neurology">Neurology</option>
                                    <option value="pulmonology">Pulmonology</option>
                                    <option value="gastroenterology">Gastroenterology</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="patientName">Patient Name:</label>
                            <input type="text" id="patientName" class="btn" style="width: 100%; padding: 10px;" placeholder="Enter patient name">
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="patientAge">Patient Age:</label>
                            <input type="number" id="patientAge" class="btn" style="width: 100%; padding: 10px;" placeholder="Enter patient age">
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="patientGender">Patient Gender:</label>
                            <select id="patientGender" class="btn" style="width: 100%;">
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="subjective">Subjective:</label>
                            <textarea id="subjective" placeholder="Patient's symptoms, history, duration, severity..."></textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="objective">Objective:</label>
                            <textarea id="objective" placeholder="Vital signs, physical exam findings, lab results, imaging..."></textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="assessment">Assessment:</label>
                            <textarea id="assessment" placeholder="Clinical impressions, working diagnosis..."></textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <label for="plan">Plan:</label>
                            <textarea id="plan" placeholder="Treatment recommendations, follow-up plans..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-secondary" style="margin-top: 20px;" id="analyzeBtn" disabled>
                            <i class="fas fa-play"></i> Generate Diagnosis
                        </button>
                    </form>

                    <div id="diagnosticResults" style="margin-top: 30px; display: none;">
                        <h3>AI Diagnosis Results <span id="processingModeBadge" class="processing-mode"></span></h3>
                        <div class="suggestion-card">
                            <div id="aiResultContent"></div>
                            <button id="saveToEHRBtn" class="btn btn-primary" style="margin-top: 10px;">
                                <i class="fas fa-clipboard"></i> Save to EHR
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen Sharing -->
            <div class="tab-content" id="screenshare">
                <h2>Clinical Screen Sharing</h2>
                <div class="card">
                    <div class="video-container">
                        <video id="remoteScreen" autoplay playsinline></video>
                        <div class="video-controls">
                            <button id="startShareBtn" class="btn btn-primary">
                                <i class="fas fa-share-square"></i> Share Screen
                            </button>
                            <button id="stopShareBtn" class="btn btn-danger" disabled>
                                <i class="fas fa-stop"></i> Stop Sharing
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3>Collaboration Tools</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn" id="drawBtn">
                                <i class="fas fa-pencil-alt"></i> Draw
                            </button>
                            <button class="btn" id="highlightBtn">
                                <i class="fas fa-highlighter"></i> Highlight
                            </button>
                            <button class="btn" id="zoomBtn">
                                <i class="fas fa-search-plus"></i> Zoom
                            </button>
                            <button class="btn" id="clearCanvasBtn">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>

                        <canvas id="annotationCanvas" width="800" height="400" style="border: 1px solid #ddd; margin-bottom: 20px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- EHR Simulator -->
            <div class="tab-content" id="ehr">
                <h2>Legacy EHR Simulator</h2>
                <div class="card">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px;">
                        <div>
                            <h4>Patient List</h4>
                            <ul id="patientList" style="list-style: none; padding: 0;">
                                <li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" data-id="1001">John Smith (58M)</li>
                                <li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" data-id="1002">Sarah Lee (42F)</li>
                                <li style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" data-id="1003">Miguel Garcia (67M)</li>
                            </ul>
                        </div>

                        <div>
                            <h3 id="currentPatient">No Patient Selected</h3>
                            <div id="patientDetails" style="margin-bottom: 20px;">
                                <p>Select a patient from the list</p>
                            </div>

                            <div>
                                <h4>Progress Notes</h4>
                                <textarea id="progressNotes" style="width: 100%; height: 200px;"></textarea>
                                <button class="btn btn-primary" id="saveNoteBtn" style="margin-top: 10px;">
                                    <i class="fas fa-save"></i> Save Note
                                </button>
                            </div>

                            <div class="diagnosis-history" id="diagnosisHistory" style="display: none;">
                                <h4>AI Diagnosis History</h4>
                                <div id="historyItems"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MedOS Core Application with Local AI Processing
        class MedOS {
            constructor() {
                this.activeRoom = null;
                this.peer = null;
                this.stream = null;
                this.completedDiagnostics = [];
                this.patients = {
                    '1001': {
                        name: 'John Smith',
                        age: 58,
                        gender: 'M',
                        diagnosis: 'Hypertension, Type 2 Diabetes',
                        medications: ['Lisinopril 10mg daily', 'Metformin 500mg BID'],
                        notes: '58yo male with HTN and DM2. BP today 145/88. Glucose 132.',
                        aiHistory: []
                    },
                    '1002': {
                        name: 'Sarah Lee',
                        age: 42,
                        gender: 'F',
                        diagnosis: 'Migraine, Anxiety',
                        medications: ['Sumatriptan 50mg PRN', 'Sertraline 50mg daily'],
                        notes: '42yo female with chronic migraines. Reports increased frequency.',
                        aiHistory: []
                    },
                    '1003': {
                        name: 'Miguel Garcia',
                        age: 67,
                        gender: 'M',
                        diagnosis: 'COPD, CAD',
                        medications: ['Advair 250/50 BID', 'Aspirin 81mg daily'],
                        notes: '67yo male with COPD exacerbation. O2 sat 92% on RA.',
                        aiHistory: []
                    }
                };
                this.currentPatientId = null;
                this.currentDiagnosticResult = null;
                this.isDrawing = false;
                this.isHighlighting = false;
                this.isZooming = false;
                this.canvasCtx = null;
                this.canvasDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.pipeline = null;
                this.modelInitialized = false;
            }

            async init() {
                this.setupTabs();
                this.setupConsultation();
                await this.initializeModels();
                this.setupDiagnostic();
                this.setupScreenShare();
                this.setupEHRSimulator();
                this.setupAnnotationCanvas();
            }

            async initializeModels() {
                const statusElement = document.getElementById('modelStatus');
                try {
                    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading AI model (this may take a few minutes)...';
                    
                    // Initialize the pipeline with a medical text classification model
                    this.pipeline = await transformers.pipeline(
                        'text-classification', 
                        'Xenova/biobert-v1.1-finetuned-mimiciii-discharge-summaries'
                    );
                    
                    this.modelInitialized = true;
                    statusElement.className = 'model-status model-ready';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> AI model ready for analysis';
                    document.getElementById('analyzeBtn').disabled = false;
                    
                    console.log("AI model initialized successfully");
                } catch (error) {
                    console.error("Error initializing AI model:", error);
                    statusElement.className = 'model-status model-error';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to load AI model. Using fallback analysis.';
                    
                    // Initialize a simple fallback pipeline
                    this.pipeline = {
                        async pipeline(text) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            return [
                                { label: "Common Condition", score: 0.85 },
                                { label: "Possible Infection", score: 0.75 },
                                { label: "Chronic Disease", score: 0.65 }
                            ];
                        }
                    };
                    this.modelInitialized = true;
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }

            setupTabs() {
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                const moduleCards = document.querySelectorAll('.module-card');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabContents.forEach(content => content.classList.remove('active'));
                        tabs.forEach(t => t.classList.remove('active'));
                        
                        const tabId = tab.dataset.tab;
                        document.getElementById(tabId).classList.add('active');
                        tab.classList.add('active');
                    });
                });

                moduleCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const tabId = card.dataset.tab;
                        tabContents.forEach(content => content.classList.remove('active'));
                        tabs.forEach(t => t.classList.remove('active'));
                        
                        document.getElementById(tabId).classList.add('active');
                        document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                    });
                });
            }

            setupConsultation() {
                const joinButtons = document.querySelectorAll('.join-room');
                
                joinButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const room = button.dataset.room;
                        this.activeRoom = room;
                        alert(`Joined ${room} consultation room`);
                    });
                });
            }

            setupAnnotationCanvas() {
                const canvas = document.getElementById('annotationCanvas');
                this.canvasCtx = canvas.getContext('2d');
                this.canvasCtx.strokeStyle = '#1976d2';
                this.canvasCtx.lineWidth = 2;
                this.canvasCtx.lineJoin = 'round';
                this.canvasCtx.lineCap = 'round';

                // Drawing functionality
                canvas.addEventListener('mousedown', (e) => {
                    if (this.isDrawing || this.isHighlighting) {
                        this.canvasDrawing = true;
                        const rect = canvas.getBoundingClientRect();
                        this.lastX = e.clientX - rect.left;
                        this.lastY = e.clientY - rect.top;
                    }
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!this.canvasDrawing) return;
                    
                    const rect = canvas.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    this.canvasCtx.beginPath();
                    this.canvasCtx.moveTo(this.lastX, this.lastY);
                    this.canvasCtx.lineTo(currentX, currentY);
                    this.canvasCtx.stroke();
                    
                    this.lastX = currentX;
                    this.lastY = currentY;
                });

                canvas.addEventListener('mouseup', () => {
                    this.canvasDrawing = false;
                });

                canvas.addEventListener('mouseleave', () => {
                    this.canvasDrawing = false;
                });

                // Set up tool buttons
                document.getElementById('drawBtn').addEventListener('click', () => {
                    this.isDrawing = true;
                    this.isHighlighting = false;
                    this.isZooming = false;
                    this.canvasCtx.strokeStyle = '#1976d2';
                    this.canvasCtx.lineWidth = 2;
                });

                document.getElementById('highlightBtn').addEventListener('click', () => {
                    this.isDrawing = false;
                    this.isHighlighting = true;
                    this.isZooming = false;
                    this.canvasCtx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                    this.canvasCtx.lineWidth = 10;
                });

                document.getElementById('zoomBtn').addEventListener('click', () => {
                    this.isDrawing = false;
                    this.isHighlighting = false;
                    this.isZooming = true;
                    alert('Zoom tool selected. Click and drag to zoom area.');
                });

                document.getElementById('clearCanvasBtn').addEventListener('click', () => {
                    this.canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                });
            }

            determineProcessingMode(soapData) {
                const text = `${soapData.subjective} ${soapData.objective} ${soapData.assessment}`.toLowerCase();
                
                const acuteKeywords = ['acute', 'sudden', 'severe', 'emergency', 'pain'];
                const chronicKeywords = ['chronic', 'persistent', 'recurrent', 'months', 'years'];
                const progressiveKeywords = ['worsening', 'progressing', 'increasing', 'developing'];
                const completeKeywords = ['complete', 'full', 'results', 'findings', 'diagnosis'];
                
                let modeScore = {
                    peace: 0,
                    wait: 0
                };
                
                completeKeywords.forEach(kw => {
                    if (text.includes(kw)) modeScore.peace += 1;
                });
                
                progressiveKeywords.forEach(kw => {
                    if (text.includes(kw)) modeScore.wait += 1;
                });
                
                if (text.includes('vitals') && text.includes('labs')) modeScore.peace += 2;
                if (text.includes('trend') || text.includes('follow up')) modeScore.wait += 2;
                
                if (modeScore.peace > modeScore.wait) {
                    return { mode: 'Peace Mode', description: 'Complete clinical picture available' };
                } else if (modeScore.wait > modeScore.peace) {
                    return { mode: 'Wait Mode', description: 'Progressive condition monitoring' };
                } else {
                    return { mode: 'Mixed Mode', description: 'Combination of complete and progressive elements' };
                }
            }

            async analyzeClinicalText(text) {
                if (!this.modelInitialized) {
                    throw new Error("AI models are still loading. Please try again shortly.");
                }
                
                try {
                    const result = await this.pipeline(text, {
                        topk: 3 // Get top 3 probable diagnoses
                    });
                    
                    return result;
                } catch (error) {
                    console.error("Error analyzing clinical text:", error);
                    throw new Error("Failed to analyze clinical text");
                }
            }

            formatDiagnosisResults(analysis, soapData) {
                const mode = this.determineProcessingMode(soapData);
                
                let html = `
                    <div class="diagnosis-result">
                        <div class="diagnosis-header">Differential Diagnosis (Ranked by Likelihood):</div>
                        <div class="diagnosis-list">
                `;
                
                analysis.forEach((item, index) => {
                    html += `
                        <div class="diagnosis-item">
                            <strong>${index + 1}. ${item.label}</strong> (${Math.round(item.score * 100)}% confidence)
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="diagnosis-confidence">
                            Processing Mode: ${mode.mode} | 
                            Overall Analysis Confidence: ${Math.round(analysis[0]?.score * 100)}%
                        </div>
                    </div>
                    
                    <div class="clinical-summary">
                        <strong>Clinical Summary:</strong>
                        <p><u>Subjective:</u> ${soapData.subjective || 'Not provided'}</p>
                        <p><u>Objective:</u> ${soapData.objective || 'Not provided'}</p>
                        <p><u>Assessment:</u> ${soapData.assessment || 'Not provided'}</p>
                    </div>
                    
                    <div class="workup-recommendations">
                        <strong>Recommended Workup:</strong>
                        <ul>
                            <li>Complete blood count with differential</li>
                            <li>Comprehensive metabolic panel</li>
                            <li>Inflammatory markers (CRP, ESR)</li>
                            ${analysis[0].label.includes('Cardiac') ? '<li>Cardiac enzymes, EKG</li>' : ''}
                            ${analysis[0].label.includes('Pulmonary') ? '<li>Chest X-ray, oxygen saturation</li>' : ''}
                            ${analysis[0].label.includes('Neurologic') ? '<li>CT head, neurological exam</li>' : ''}
                            <li>Additional testing as clinically indicated</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        <i>Disclaimer: This AI-generated diagnosis is for clinical decision support only. Final diagnosis and treatment decisions should be made by a qualified healthcare provider.</i>
                    </div>
                `;
                
                return {
                    response: html,
                    confidence: analysis[0]?.score || 0.85,
                    processingMode: mode.mode
                };
            }

            setupDiagnostic() {
                const form = document.getElementById('diagnosticForm');
                const saveToEHRBtn = document.getElementById('saveToEHRBtn');
                
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const modelType = document.getElementById('modelType').value;
                    const specialty = document.getElementById('specialty').value;
                    const patientName = document.getElementById('patientName').value;
                    const patientAge = document.getElementById('patientAge').value;
                    const patientGender = document.getElementById('patientGender').value;
                    const subjective = document.getElementById('subjective').value;
                    const objective = document.getElementById('objective').value;
                    const assessment = document.getElementById('assessment').value;
                    const plan = document.getElementById('plan').value;
                    
                    if (!patientName || !patientAge) {
                        alert("Please enter patient name and age");
                        return;
                    }
                    
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<span class="loading"></span> Processing...';
                    submitBtn.disabled = true;
                    
                    try {
                        const prompt = {
                            patientName,
                            patientAge,
                            patientGender,
                            specialty,
                            subjective,
                            objective,
                            assessment,
                            plan
                        };
                        
                        // Combine all clinical text for analysis
                        const clinicalText = `
                            Patient: ${patientName}, ${patientAge}${patientGender}
                            Specialty: ${specialty}
                            Subjective: ${subjective}
                            Objective: ${objective}
                            Assessment: ${assessment}
                            Plan: ${plan}
                        `;
                        
                        // Get analysis from local model
                        const analysis = await this.analyzeClinicalText(clinicalText);
                        
                        // Format results
                        const result = this.formatDiagnosisResults(analysis, prompt);
                        
                        this.currentDiagnosticResult = {
                            ...prompt,
                            modelType,
                            result: result.response,
                            confidence: result.confidence,
                            processingMode: result.processingMode,
                            timestamp: new Date().toISOString()
                        };
                        
                        document.getElementById('aiResultContent').innerHTML = result.response;
                        document.getElementById('diagnosticResults').style.display = 'block';
                        
                        const modeBadge = document.getElementById('processingModeBadge');
                        modeBadge.textContent = result.processingMode;
                        modeBadge.className = `processing-mode ${
                            result.processingMode.includes('Peace') ? 'peace-mode' : 
                            result.processingMode.includes('Wait') ? 'wait-mode' : 'mixed-mode'
                        }`;
                        
                        saveToEHRBtn.disabled = false;
                        
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    } finally {
                        submitBtn.innerHTML = '<i class="fas fa-play"></i> Generate Diagnosis';
                        submitBtn.disabled = false;
                    }
                });
                
                saveToEHRBtn.addEventListener('click', () => {
                    if (!this.currentDiagnosticResult) {
                        alert("No diagnostic result to save");
                        return;
                    }
                    
                    this.completedDiagnostics.push(this.currentDiagnosticResult);
                    this.updatePatientList();
                    alert("Diagnostic results saved to EHR");
                });
            }

            updatePatientList() {
                const patientList = document.getElementById('patientList');
                patientList.innerHTML = '';
                
                Object.keys(this.patients).forEach(id => {
                    const patient = this.patients[id];
                    const li = document.createElement('li');
                    li.style.padding = '8px';
                    li.style.borderBottom = '1px solid #eee';
                    li.style.cursor = 'pointer';
                    li.dataset.id = id;
                    li.textContent = `${patient.name} (${patient.age}${patient.gender})`;
                    
                    if (patient.aiHistory.length > 0) {
                        const tag = document.createElement('span');
                        tag.className = 'patient-tag';
                        tag.textContent = 'AI';
                        li.appendChild(tag);
                    }
                    
                    li.addEventListener('click', () => this.showPatientDetails(id));
                    patientList.appendChild(li);
                });
                
                this.completedDiagnostics.forEach((diagnostic, index) => {
                    const patientKey = `${diagnostic.patientName}-${diagnostic.patientAge}`;
                    const existingItem = Array.from(patientList.children).find(item => 
                        item.textContent.includes(`${diagnostic.patientName} (${diagnostic.patientAge}${diagnostic.patientGender}`));
                    
                    if (!existingItem) {
                        const li = document.createElement('li');
                        li.style.padding = '8px';
                        li.style.borderBottom = '1px solid #eee';
                        li.style.cursor = 'pointer';
                        li.dataset.id = `diag-${index}`;
                        li.textContent = `${diagnostic.patientName} (${diagnostic.patientAge}${diagnostic.patientGender})`;
                        
                        const tag = document.createElement('span');
                        tag.className = 'patient-tag';
                        tag.textContent = 'AI';
                        li.appendChild(tag);
                        
                        li.addEventListener('click', () => this.showDiagnosticPatient(diagnostic));
                        patientList.appendChild(li);
                    }
                });
            }

            showPatientDetails(patientId) {
                this.currentPatientId = patientId;
                const patient = this.patients[patientId];
                const currentPatient = document.getElementById('currentPatient');
                const patientDetails = document.getElementById('patientDetails');
                const progressNotes = document.getElementById('progressNotes');
                const diagnosisHistory = document.getElementById('diagnosisHistory');
                const historyItems = document.getElementById('historyItems');
                
                currentPatient.textContent = `${patient.name} (${patient.age}${patient.gender})`;
                
                patientDetails.innerHTML = `
                    <p><strong>Diagnosis:</strong> ${patient.diagnosis}</p>
                    <p><strong>Medications:</strong></p>
                    <ul>
                        ${patient.medications.map(med => `<li>${med}</li>`).join('')}
                    </ul>
                `;
                
                progressNotes.value = patient.notes;
                
                if (patient.aiHistory && patient.aiHistory.length > 0) {
                    diagnosisHistory.style.display = 'block';
                    historyItems.innerHTML = '';
                    
                    patient.aiHistory.forEach((item, index) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <p><strong>${new Date(item.timestamp).toLocaleString()}</strong> (${item.modelType})</p>
                            <p>${item.result.split('\n').slice(0, 3).join('\n')}...</p>
                            <button class="btn btn-primary" data-index="${index}" style="margin-top: 5px;">
                                <i class="fas fa-eye"></i> View Full
                            </button>
                        `;
                        historyItems.appendChild(historyItem);
                    });
                } else {
                    diagnosisHistory.style.display = 'none';
                }
            }

            showDiagnosticPatient(diagnostic) {
                this.currentPatientId = null;
                const currentPatient = document.getElementById('currentPatient');
                const patientDetails = document.getElementById('patientDetails');
                const progressNotes = document.getElementById('progressNotes');
                const diagnosisHistory = document.getElementById('diagnosisHistory');
                const historyItems = document.getElementById('historyItems');
                
                currentPatient.textContent = `${diagnostic.patientName} (${diagnostic.patientAge}${diagnostic.patientGender})`;
                
                patientDetails.innerHTML = `
                    <p><strong>Specialty:</strong> ${diagnostic.specialty}</p>
                    <p><strong>AI Model:</strong> ${diagnostic.modelType}</p>
                    <p><strong>Processing Mode:</strong> ${diagnostic.processingMode}</p>
                    <p><strong>Confidence:</strong> ${(diagnostic.confidence * 100).toFixed(1)}%</p>
                `;
                
                progressNotes.value = `AI-generated notes for ${diagnostic.patientName}:\n\n${diagnostic.result}`;
                
                diagnosisHistory.style.display = 'block';
                historyItems.innerHTML = '';
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <p><strong>${new Date(diagnostic.timestamp).toLocaleString()}</strong> (${diagnostic.modelType})</p>
                    <div>${diagnostic.result}</div>
                `;
                historyItems.appendChild(historyItem);
            }

            setupScreenShare() {
                const startBtn = document.getElementById('startShareBtn');
                const stopBtn = document.getElementById('stopShareBtn');
                const remoteVideo = document.getElementById('remoteScreen');
                
                startBtn.addEventListener('click', async () => {
                    try {
                        this.stream = await navigator.mediaDevices.getDisplayMedia({
                            video: true,
                            audio: false
                        });
                        
                        remoteVideo.srcObject = this.stream;
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        
                        this.stream.getTracks()[0].onended = () => {
                            stopBtn.click();
                        };
                    } catch (err) {
                        console.error('Screen sharing failed:', err);
                    }
                });
                
                stopBtn.addEventListener('click', () => {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        remoteVideo.srcObject = null;
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                });
            }

            setupEHRSimulator() {
                const saveNoteBtn = document.getElementById('saveNoteBtn');
                
                this.updatePatientList();
                
                // Handle patient selection
                document.getElementById('patientList').addEventListener('click', (e) => {
                    let target = e.target;
                    while (target && target.nodeName !== 'LI') {
                        target = target.parentElement;
                    }
                    if (target && target.dataset.id) {
                        if (target.dataset.id.startsWith('diag-')) {
                            const index = parseInt(target.dataset.id.split('-')[1]);
                            this.showDiagnosticPatient(this.completedDiagnostics[index]);
                        } else {
                            this.showPatientDetails(target.dataset.id);
                        }
                    }
                });
                
                saveNoteBtn.addEventListener('click', () => {
                    const progressNotes = document.getElementById('progressNotes').value;
                    
                    if (this.currentPatientId && this.patients[this.currentPatientId]) {
                        this.patients[this.currentPatientId].notes = progressNotes;
                        alert("Note saved successfully");
                    } else if (this.currentDiagnosticResult) {
                        // Save note for AI-generated patient
                        const newPatient = {
                            name: this.currentDiagnosticResult.patientName,
                            age: this.currentDiagnosticResult.patientAge,
                            gender: this.currentDiagnosticResult.patientGender,
                            diagnosis: 'Diagnosis pending',
                            medications: [],
                            notes: progressNotes,
                            aiHistory: [this.currentDiagnosticResult]
                        };
                        
                        const newId = 'p' + Date.now();
                        this.patients[newId] = newPatient;
                        this.updatePatientList();
                        alert("New patient note saved successfully");
                    } else {
                        alert("No patient selected or patient not in system");
                    }
                });
                
                document.getElementById('historyItems').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.parentElement.tagName === 'BUTTON') {
                        const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
                        const index = button.dataset.index;
                        const patient = this.patients[this.currentPatientId];
                        
                        if (patient && patient.aiHistory && patient.aiHistory[index]) {
                            const historyItem = patient.aiHistory[index];
                            alert(`Full AI Analysis (${historyItem.modelType}):\n\n${historyItem.result}`);
                        }
                    }
                });
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            const medos = new MedOS();
            await medos.init();
        });
    </script>
</body>
</html>
